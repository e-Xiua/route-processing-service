syntax = "proto3";

package route.optimization;

// Servicio principal para optimización de rutas
service RouteOptimizationService {
    // Método principal para ejecutar el modelo MRL-AMIS
    rpc OptimizeRoute(RouteOptimizationRequest) returns (RouteOptimizationResponse);

    //Consultar estado de un trabajo
    rpc GetJobStatus(JobStatusRequest) returns (JobStatusResponse);
    
    // Obtener resultado de un trabajo completado
    rpc GetJobResult(JobResultRequest) returns (RouteOptimizationResponse);
    
    // Cancelar un trabajo
    rpc CancelJob(CancelJobRequest) returns (CancelJobResponse);
    
    // Obtener información del sistema de colas
    rpc GetQueueInfo(QueueInfoRequest) returns (QueueInfoResponse);

    // Método para verificar el estado del servicio
    rpc HealthCheck(HealthRequest) returns (HealthResponse);
}

// Solicitud principal de optimización de ruta
message RouteOptimizationRequest {
    string route_id = 1;
    string user_id = 2;
    repeated POI pois = 3;
    RoutePreferences preferences = 4;
    RouteConstraints constraints = 5;
}

// Respuesta de optimización de ruta
message RouteOptimizationResponse {
    string route_id = 1;
    string message = 3;
    OptimizationResults results = 4;
    OptimizationMetrics metrics = 5;
    string job_id = 6;                      
    string status = 7;                      
    int32 queue_position = 8;               
    int32 estimated_wait_time_minutes = 9;  
}

// Definición de un POI (Point of Interest)
message POI {
    int32 id = 1;
    string name = 2;
    double latitude = 3;
    double longitude = 4;
    string category = 5;
    string subcategory = 6;
    int32 visit_duration = 7; // en minutos
    double cost = 8;
    double rating = 9;
    string description = 10;
    bool accessibility = 11;
    int32 provider_id = 12;
    string provider_name = 13;
}

// Preferencias de ruta
message RoutePreferences {
    string optimize_for = 1; // "distance", "time", "cost", "sustainability"
    int32 max_total_time = 2; // en minutos
    double max_total_cost = 3;
    bool accessibility_required = 4;
}

message HealthResponse {
    bool is_healthy = 1;
    string status = 2;
    string version = 3;
    int32 queue_size = 4; // <-- Añade este campo
    int32 active_jobs = 5; // <-- Añade este campo
}



message Location {
  double latitude = 1;
  double longitude = 2;
}


// Restricciones de ruta
message RouteConstraints {
    Location start_location = 1; 
    Location end_location = 2; 
    string start_time = 3; // formato "HH:mm"
    bool lunch_break_required = 4;
    int32 lunch_break_duration = 5; // en minutos
}

// Resultados de optimización
message OptimizationResults {
    repeated OptimizedPOI optimized_sequence = 1;
    double total_distance_km = 2;
    int32 total_time_minutes = 3;
    double total_cost = 4;
    double optimization_score = 5;
    string route_description = 6;
}

// POI optimizado con información adicional
message OptimizedPOI {
    int32 poi_id = 1;
    string poi_name = 2;
    int32 visit_order = 3;
    string arrival_time = 4; // formato "HH:mm"
    string departure_time = 5; // formato "HH:mm"  
    int32 estimated_visit_time = 6; // en minutos
    double latitude = 7;
    double longitude = 8;
}

// Métricas de optimización
message OptimizationMetrics {
    double hypervolume = 1;
    double arp = 2; // Average Ratio Performance
    double spacing = 3;
    int32 pareto_front_size = 4;
    int32 total_iterations = 5;
    double execution_time_seconds = 6;
}

// Solicitud de verificación de salud
message HealthRequest {
    string service_name = 1;
}

// Solicitud de estado de trabajo
message JobStatusRequest {
    string job_id = 1;
}

// Respuesta de estado de trabajo
message JobStatusResponse {
    string job_id = 1;
    string route_id = 2;
    string status = 3; // QUEUED, PROCESSING, COMPLETED, FAILED, CANCELLED
    float progress = 4; // 0.0 a 100.0
    string message = 5;
    string created_at = 6; // ISO 8601 timestamp
    string started_at = 7; // ISO 8601 timestamp (opcional)
    string completed_at = 8; // ISO 8601 timestamp (opcional)
    string estimated_completion_time = 9; // ISO 8601 timestamp (opcional)
    string error_message = 10; // Solo si status=FAILED
    bool has_result = 11; // true si los resultados están listos
}

// Solicitud de resultado de trabajo
message JobResultRequest {
    string job_id = 1;
}

// Solicitud de cancelación de trabajo
message CancelJobRequest {
    string job_id = 1;
}

// Respuesta de cancelación
message CancelJobResponse {
    string job_id = 1;
    bool success = 2;
    string message = 3;
}

// Solicitud de información de cola
message QueueInfoRequest {
    // Vacío por ahora, se puede extender en el futuro
}

// Respuesta de información de cola
message QueueInfoResponse {
    int32 queue_size = 1;
    int32 active_jobs = 2;
    int32 completed_jobs = 3;
    int32 max_concurrent_jobs = 4;
    bool multiprocessing_enabled = 5;
    repeated JobInfo active_jobs_detail = 6;
}

// Información resumida de un trabajo
message JobInfo {
    string job_id = 1;
    string status = 2;
    float progress = 3;
    string created_at = 4;
    string started_at = 5;
}